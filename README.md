# Serverless VPC Creation API on AWS

This project provides a serverless API to create AWS VPCs with multiple subnets, store metadata, and retrieve created resources. The API is secured using AWS Cognito User Pools. This also supports the deletion of VPC and its associated dependencies.

Both Creation and deletion APIs are executed in async mode. 


---

## ðŸš€ Deployment

### Prerequisites

- AWS CLI configured with your credentials (`aws configure`)
- AWS SAM CLI installed ([Install SAM CLI](https://docs.aws.amazon.com/serverless-application-model/latest/developerguide/install-sam-cli.html))
- Docker installed (required for SAM build)
- Python 3.11+ installed (for Cognito user script)

### Steps

1. **Build the application:**

   ```sam build```
2. **Deploy the stack:**

    ```sam deploy --guided```

   Follow the prompts to set:
   ```
   Stack name (e.g., VpcApiStack)
   AWS region (e.g., us-east-1)
   Allow SAM to create IAM roles (Yes)
   Save the configuration for future deploys (Yes)
   ```
   
   After deployment, note the output values:
   
   - API Gateway Endpoint URL
   - Cognito User Pool ID
   - Cognito App Client ID


3. **Manage Cognito Users**
   Use the provided Python script cognito_user.py to create users and generate tokens.
   
   - 3a. **Create a User**
   
          python cognito_user.py --action create --username user@example.com --password StrongP@ssw0rd123 --user-pool-id $USER_POOL_ID
      
          Password must be strong:
          Minimum 8 characters
          At least 1 uppercase, 1 lowercase, 1 digit, 1 special character
          If the user already exists, you will be notified.
   
   - 3b. **Generate Authentication Tokens**
   
          python cognito_user.py --action token --username user@example.com --password StrongP@ssw0rd123 --user-pool-id $USER_POOL_ID --client-id $CLIENT_ID
          This will output:
          Access Token
          ID Token
      
          Use this ID Token as the Authorization header when calling the API.

5. **API Usage**
   
   Base URL: "https://{api-id}.execute-api.{region}.amazonaws.com/Prod/"

   - 4a. **Create VPC with Subnets**
      
      Request:
      ```
      POST /vpc/create
      Authorization: <Access Token>
      Content-Type: application/json
      ```

      Body:
      ```
      {
        "vpc_cidr": "10.0.0.0/16",
        "subnets": [
          { "cidr": "10.0.1.0/24", "type": "public" },
          { "cidr": "10.0.2.0/24", "type": "private" }
        ]
      }
      ```
      Response: Returns the created VPC id:
      
      ```
      {
          "vpc_id": "vpc-xxxxxxxxxxxx",
          "status": "CREATING"
      }
      ```
   
   - 4b. **Get VPC creation status and Metadata (if creation completed) by VPC ID**
      
      Request:
      ```
      GET /vpc/status/{vpc_id}
      Authorization: <Access Token>
      Content-Type: application/json
      ```
      
      Response: Returns stored metadata about the VPC and its subnets.
      
      Response - during creation:
      
      ```
      {
          "vpc_id": "vpc-xxxxxxxxxxxx",
          "vpc_cidr": "<vpc-cidr>",
          "status": "CREATING"
      }
      ```
      
      Response - After succesful VPC creation:
      
      ```
      {
          "internet_gateway_id": "igw-xxxxxxxxxxx",
          "subnet_ids": [
              {
                  "type": "public",
                  "subnet_id": "subnet-xxxxxxxxxxxx",
                  "cidr": "<subnet-cidr>"
              },
              {
                  "type": "private",
                  "subnet_id": "subnet-xxxxxxxxxxxxx",
                  "cidr": "<subnet-cidr>"
              }
          ],
          "nat_gateway_id": "nat-xxxxxxxxxxxx",
          "elastic_ip_allocation_id": "eipalloc-xxxxxxxxxxxxx",
          "status": "COMPLETED",
          "vpc_id": "vpc-xxxxxxxxxxxx",
          "vpc_cidr": "<vpc-cidr>"
      }
      ```
   
   - 4c. **VPC Deletion**

      This will only delete the VPC and its associated dependencies. It will not remove any resources deployed inside this VPC. If such resources exist, VPC deletion will fail. 
      
   
      Request:
      ```
      DELETE /vpc/delete/{vpc_id}
      Authorization: <Access Token>
      Content-Type: application/json
      ```
      Response: Initiates the deletion and provides the status
      ```
      {
          "message": "Deletion triggered for VPC vpc-xxxxxxxxx"
      }
      ```

6. **Authentication & Authorization**

   API is protected by AWS Cognito User Pool authorizer.
   
   All authenticated users can create and read VPC resources.
   
   Use tokens generated by cognito_user.py to authorize API calls. Refer step 3 for details. 

7. **Development & Testing**

   Use sam logs -n YourFunctionName --stack-name YourStackName to check Lambda logs.
   
   Use AWS Console DynamoDB to view stored VPC metadata.
   
   Modify and redeploy with:
   
   ```sam build```
   
   ```sam deploy```

8. **Environment Variables (.env)**

   To simplify usage, create a .env file in your project root with the following variables:
   
   ```USER_POOL_ID=us-east-1_xxxxxxxx```
   ```CLIENT_ID=xxxxxxxxxxxxxxxxxxxxxxxxxx```
   ```API_URL=https://<api-id>.execute-api.<region>.amazonaws.com/Prod```
   
   Then you can load them in your shell:
   
   ```export $(grep -v '^#' .env | xargs)```
   And use variables like $USER_POOL_ID and $CLIENT_ID in commands.
